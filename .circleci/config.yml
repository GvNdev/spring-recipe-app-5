# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  build:
    docker:
      # specify the version you desire here
      - image: cimg/openjdk:21.0

    working_directory: ~/sfg-recipe-app-5

    environment:
      # Customize the JVM maximum heap limit
      MAVEN_OPTS: -Xmx3200m

    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-

      - run:
          name: Go offline
          command: mvn -B -ntp -DskipTests dependency:go-offline

      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "pom.xml" }}

      # run tests! and gen code coverage
      - run:
          name: Test + Coverage (UT + IT)
          command: mvn -B -ntp verify

      - store_test_results:
          path: target/surefire-reports
      - store_test_results:
          path: target/failsafe-reports

      - run:
          name: Debug coverage files
          command: |
            ls -la target/site || true
            find target -maxdepth 4 -type f -name "jacoco*.xml" -print || true

      - run:
          name: Confirm jacoco.xml exists
          command: |
            ls -a target/site/jacoco || true
            test -f target/site/jacoco/jacoco.xml && echo "OK: jacoco.xml exists" || (echo "MISSING jacoco.xml" && exit 1)

      - run:
          name: Upload to Codecov (CLI, fail-on-error)
          command: |
            curl -Os https://cli.codecov.io/latest/linux/codecov
            chmod +x codecov
            ./codecov --verbose upload-process --disable-search --fail-on-error \
              -t "${3afc4b38-2c1f-43c3-a6de-7861195551da}" \
              -f target/sit/jacoco/jacoco.xml

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  sample: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build