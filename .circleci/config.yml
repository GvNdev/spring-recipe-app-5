# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  build:
    docker:
      # specify the version you desire here
      - image: cimg/openjdk:21.0

    working_directory: ~/sfg-recipe-app-5

    environment:
      # Customize the JVM maximum heap limit
      MAVEN_OPTS: -Xmx3200m

    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-

      - run:
          name: Go offline
          command: mvn -B -ntp -DskipTests dependency:go-offline

      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "pom.xml" }}

      # run tests! and gen code coverage
      - run:
          name: Test + Coverage (UT + IT)
          command: mvn -B -ntp verify

      - run:
          name: Prepare JUnit test results (exclude non-JUnit xml)
          command: |
            mkdir -p test-results/surefire test-results/failsafe
            cp -v target/surefire-reports/TEST-*.xml test-results/surefire/ || true
            cp -v target/failsafe-reports/TEST-*.xml test-results/failsafe/ || true

      - store_test_results:
          path: test-results

      - store_artifacts:
          path: target/failsafe-reports/failsafe-summary.xml

      - run:
          name: Upload coverage to Codecov (explicit jacoco.xml)
          command: |
            echo "Branch: ${CIRCLE_BRANCH}"
            echo "SHA: ${CIRCLE_SHA1}"
            git rev-parse HEAD
            
            curl -Os https://cli.codecov.io/latest/linux/codecov
            chmod +x codecov
            ./codecov --version
            
            ./codecov --verbose upload-process \
              --fail-on-error \
              --disable-search \
              -t "${CODECOV_TOKEN}" \
              -n "circleci-${CIRCLE_BUILD_NUM}" \
              -F "ut,it" \
              -f "target/site/jacoco/jacoco.xml"

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  sample: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build