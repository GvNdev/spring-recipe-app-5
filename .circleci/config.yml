# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  build:
    docker:
      # specify the version you desire here
      - image: cimg/openjdk:21.0

    working_directory: ~/sfg-recipe-app-5

    environment:
      # Customize the JVM maximum heap limit
      GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx3200m -Dfile.encoding=UTF-8"

    steps:
      - checkout

      - restore_cache:
          keys:
            - v2-gradle-deps-{{ checksum "build.gradle" }}-{{ checksum "settings.gradle" }}
            # fallback to using the latest cache if no exact match is found
            - v2-gradle-deps-

      # Warm up dependencies (similar intent to mvn dependency:go-offline
      - run:
          name: Warm Gradle dependencies
          command: ./gradlew --no-daemon --refresh-dependencies dependencies || true

      - save_cache:
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
          key: v2-gradle-deps-{{ checksum "build.gradle" }}-{{ checksum "settings.gradle" }}

      # Ensure Gradle wrapper is executable (sometimes needed on Linux containers)
      - run:
          name: Make Gradle wrapper executable
          command: |
            ls -la ./gradlew
            chmod -x ./gradlew
            ls -la ./gradlew

      # Run tests + coverage (UT + IT) and generate merged JaCoCo XML
      - run:
          name: Test + Coverage (UT + IT)
          command: bash ./gradlew --no-daemon clean check

      - run:
          name: Prepare JUnit test results
          command: |
            mkdir -p test-results/unit test-results/integration
            cp -v build/test-results/test/TEST-*.xml test-results/unit/ || true
            cp -v build/test-results/integrationTest/TEST-*.xml test-results/integration/ || true

      - store_test_results:
          path: test-results

      # Optional artifacts (useful for debugging CI failures)
      - store_artifacts:
          path: build/reports/tests/test
      - store_artifacts:
          path: build/reports/tests/integrationTest
      - store_artifacts:
          path: build/reports/jacoco/jacoco.xml

      - run:
          name: Upload coverage to Codecov (force GitHub repo slug)
          command: |
            REPO_URL="$(git remote get-url origin)"
            echo "origin=$REPO_URL"
            
            SLUG="$(echo "$REPO_URL" | sed -E 's#(https://github.com/|git@github.com:)([^/]+)/([^/.]+)(\.git)?#\2/\3#')"
            echo "slug=$SLUG"
            
            curl -Os https://cli.codecov.io/latest/linux/codecov
            chmod +x codecov
            ./codecov --version
            
            ./codecov --verbose upload-process \
              -t "$CODECOV_TOKEN" \
              -r "$SLUG" \
              -f "target/site/jacoco/jacoco.xml"

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  sample: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build